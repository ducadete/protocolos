<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo de Bolso - Saúde da Família</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; }
        .modal.is-open { display: flex; }
        .modal-enter { animation: modal-enter 0.3s ease-out forwards; }
        .modal-leave { animation: modal-leave 0.3s ease-in forwards; }
        @keyframes modal-enter { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes modal-leave { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.9); } }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 md:p-6">
        <div id="main-screen" class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800">Protocolos da Saúde da Família</h1>
            </div>
            <div class="relative">
                <input type="text" id="search-input" placeholder="Pesquisar por nome, tema, CID..." class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-full">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg>
            </div>
            <div id="search-results" class="mt-6 space-y-3"></div>
            <p id="no-results" class="text-center text-gray-500 mt-8 hidden">Nenhum protocolo encontrado.</p>
        </div>
    </div>

    <!-- Modal Detalhes do Protocolo -->
    <div id="protocol-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-60 items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 modal-content">
            <div class="flex justify-between items-start"><h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-4"></h3><button id="close-protocol-modal" class="text-gray-400 hover:text-gray-600">&times;</button></div>
            <div class="space-y-5 text-gray-700">
                <div><h4 class="font-semibold border-b pb-2 mb-2">Resumo</h4><p id="modal-summary"></p></div>
                <div><h4 class="font-semibold border-b pb-2 mb-2">Pontos Principais</h4><ul id="modal-main-points" class="list-disc list-inside"></ul></div>
                <div><h4 class="font-semibold border-b pb-2 mb-2">Fluxo do Protocolo</h4><ul id="modal-flow" class="list-decimal list-inside space-y-2 text-sm"></ul></div>
                <div><h4 class="font-semibold border-b pb-2 mb-2">Faixa Etária e CIDs</h4><p><span class="font-medium">Idades:</span> <span id="modal-ages"></span></p><p><span class="font-medium">CIDs:</span> <span id="modal-cids"></span></p></div>
                <div><h4 class="font-semibold border-b pb-2 mb-2">Anexos</h4><div id="modal-attachments" class="space-y-2"></div></div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- BASE DE DADOS LOCAL ---
        // Para adicionar ou alterar um protocolo, edite esta lista.
        const databaseDeProtocolos = [
            {
                "id": "1",
                "nome": "Profilaxia Pós-Exposição (PEP) ao HIV",
                "tema": "IST / HIV / Hepatites Virais",
                "resumo": "A Profilaxia Pós-Exposição (PEP) é uma medida de prevenção de urgência para reduzir o risco de infeção pelo HIV, hepatites virais e outras ISTs, após qualquer situação em que exista risco de contágio. A PEP deve ser iniciada o mais rápido possível, preferencialmente nas primeiras 2 horas e no máximo em até 72 horas.",
                "descricao": "Consiste no uso de medicamentos antirretrovirais por 28 dias. A indicação depende da avaliação do tipo de exposição, do tempo decorrido e do estado serológico da pessoa exposta. Existem esquemas específicos para adultos, grávidas e crianças.",
                "principais": ["O atendimento deve ocorrer em até 72 horas após a exposição.", "O tratamento dura 28 dias e a adesão é fundamental.", "Esquema preferencial para adultos: Tenofovir/Lamivudina (TDF/3TC) + Dolutegravir (DTG).", "Encaminhamento obrigatório para serviços especializados (CTA, Casa da Mulher, CRMI) para acompanhamento.", "A testagem para HIV, Sífilis e Hepatites B e C é parte essencial do atendimento."],
                "fluxo": ["Avaliação inicial do risco da exposição (até 72h).", "Realização de testes rápidos para HIV, Sífilis e Hepatites B/C.", "Prescrição do esquema antirretroviral (ARV) por 28 dias.", "Fornecimento da medicação inicial no serviço de urgência.", "Encaminhamento para o serviço de acompanhamento especializado (CTA, CRMI, etc.) no próximo dia útil.", "Acompanhamento e reavaliação sorológica conforme indicado."],
                "cids": "Z20.6, Z71.7",
                "idades": "Todas as faixas etárias",
                "anexos": [{ "nome": "Protocolo Completo PEP.pdf", "url": "https://drive.google.com/file/d/1RFZB2NbufegEENCVKNdWuS-lv-cOl5YA/view?usp=sharing" }]
            },
            {
                "id": "2",
                "nome": "Fluxograma para Investigação de Sífilis em Gestantes",
                "tema": "Pré-Natal / IST / Saúde da Mulher",
                "resumo": "Este protocolo estabelece o fluxo de ação para gestantes com Teste Rápido (TR) de Sífilis reagente, orientando a conduta imediata para tratamento e monitorização, visando a prevenção da sífilis congénita.",
                "descricao": "O fluxograma define os passos a serem seguidos a partir de um resultado de Teste Rápido (TR) de sífilis reagente durante o pré-natal. A abordagem inclui o início imediato do tratamento, a investigação e tratamento das parcerias sexuais, a notificação compulsória e a monitorização mensal da resposta ao tratamento através do VDRL.",
                "principais": ["Todo Teste Rápido (TR) de Sífilis REAGENTE exige ação imediata.", "Iniciar o tratamento da gestante imediatamente, de acordo com a classificação clínica, sem aguardar o resultado do VDRL.", "O tratamento deve ser anotado na carteira da gestante e no prontuário eletrónico.", "É mandatório realizar o tratamento presuntivo das parcerias sexuais dos últimos 90 dias.", "A notificação de Sífilis em Gestante é compulsória.", "A monitorização da resposta ao tratamento é feita com VDRL mensal."],
                "fluxo": ["Realização do Teste Rápido (TR) para Sífilis na gestante (1º, 2º e 3º trimestres).", "Se o TR for REAGENTE: colher VDRL imediatamente, acionar a frota e iniciar o tratamento da gestante.", "Realizar tratamento presuntivo das parcerias sexuais e orientar sobre sexo seguro.", "Notificar o caso de Sífilis em Gestante.", "Monitorizar mensalmente a gestante com teste não treponémico (VDRL).", "Considerar resposta adequada ao tratamento a queda de pelo menos 2 diluições nos títulos do VDRL em 6 meses (ex: de 1/64 para 1/16)."],
                "cids": "A50, A51, A52, A53, Z34",
                "idades": "Gestantes",
                "anexos": [{ "nome": "Fluxograma-Sífilis-Gestantes-Bauru-2023.pdf", "url": "https://drive.google.com/file/d/1DIDz-Gzxxj2FtC05UQ-2dAsq5dVwqNM6/view?usp=drive_link" }]
            },
            {
                "id": "3",
                "nome": "Programa de Tratamento Fora do Domicílio (TFD)",
                "tema": "Serviço Social / Transporte Sanitário",
                "resumo": "Programa que custeia as despesas de deslocamento de pacientes para tratamento médico em outros municípios, conforme a Lei Municipal N°4.963/2003.",
                "descricao": "O TFD garante o acesso de pacientes a tratamentos médicos em cidades de referência. O processo requer documentação específica, avaliação socioeconômica na UBS e uma perícia médica para autorizar o tratamento, definir o transporte e a necessidade de acompanhante.",
                "principais": ["A solicitação deve ser feita com pelo menos 15 dias de antecedência.", "É obrigatório o preenchimento do formulário/laudo médico próprio do TFD pelo médico solicitante do SUS.", "A avaliação socioeconômica é realizada na Unidade Básica de Saúde de referência do paciente.", "A perícia médica é soberana na decisão de autorizar o processo.", "A ajuda de custo para alimentação pode ser concedida após avaliação socioeconômica."],
                "fluxo": ["Paciente/UBS reúne a documentação necessária (formulário, avaliação, cópias de documentos, agendamentos).", "A documentação é entregue na Seção de Apoio Social para análise e agendamento da perícia.", "A perícia médica avalia o caso e emite o parecer.", "Após a perícia, o paciente é atendido pela assistente social para orientações e agendamento do transporte."],
                "cids": "Variável",
                "idades": "Todas as faixas etárias",
                "anexos": [
                    { "nome": "Formulário Laudo Médico TFD.pdf", "url": "https://drive.google.com/file/d/1oCZEcU6rX_ma0PYjy1A70md6SZIOLZMG/view?usp=sharing" }
                ]
            },
            {
                "id": "4",
                "nome": "Encaminhamento para Psicologia Pediátrica (Policlínica)",
                "tema": "Saúde Mental Infantil / Juvenil",
                "resumo": "Orienta o encaminhamento de pacientes de 3 a 17 anos, classificados como risco médio, para a especialidade de Psicologia Pediátrica na Policlínica, através do prontuário eletrónico (MV/SIGSS).",
                "descricao": "Detalha o procedimento correto para a solicitação eletrónica, incluindo a inserção da hipótese diagnóstica (SOAP ou HD), a seleção do CID apropriado e a descrição detalhada da demanda. O protocolo destaca os critérios de prioridade e os procedimentos da Central de Regulação.",
                "principais": ["Válido para casos de risco médio, entre 3 e 17 anos.", "O encaminhamento deve ser feito exclusivamente pelo Prontuário Eletrónico (MV/SIGSS).", "É obrigatório inserir a Hipótese Diagnóstica (SOAP/HD) e o CID.", "Crianças e adolescentes em acolhimento institucional (abrigos) são prioritários."],
                "fluxo": ["Profissional acede ao prontuário eletrónico (MV/SIGSS).", "Na aba 'Encaminhamento', seleciona a especialidade 'PSICOLOGIA PEDIÁTRICA'.", "Insere a Hipótese Diagnóstica (SOAP) e o CID previsto.", "Descreve em detalhe a demanda do paciente.", "A Central de Regulação analisa o caso (Autorizado, Negado ou Devolvido).", "Se autorizado, a Regulação agenda a vaga e informa a unidade de saúde de origem."],
                "cids": "F32, F33, F34, F39, F41, F43, F52, F53, F54, F59, F68, F69, F88, F89, F92, F94",
                "idades": "3 a 17 anos",
                "anexos": [
                    { "nome": "Estratificação de risco.pdf", "url": "https://drive.google.com/file/d/1opiU4aQQK856BaoAFmTtglrncpU2nbPM/view?usp=drive_link" }
                ]
            },
            {
                "id": "5",
                "nome": "Encaminhamento para Psicologia Clínica (Adulto)",
                "tema": "Saúde Mental Adulto",
                "resumo": "Orienta o encaminhamento de pacientes a partir de 18 anos, classificados como risco médio, para a Psicologia Clínica. O processo é feito via prontuário eletrónico (MV/SIGSS) e a vaga é disponibilizada por SIRESP.",
                "descricao": "Este protocolo detalha o fluxo para solicitar atendimento psicológico para adultos. É crucial que o profissional insira o SOAP ou Hipótese Diagnóstica e o CID correto. A disponibilização das vagas não é regulada diretamente pela Policlínica, mas sim via SIRESP. O início dos atendimentos está condicionado à diminuição da fila de espera da Psicologia Pediátrica.",
                "principais": ["Válido para pacientes com 18 anos ou mais, estratificados como risco médio.", "O encaminhamento é feito pela aba 'Encaminhamento' no prontuário eletrónico (MV/SIGSS).", "É obrigatório identificar o SOAP ou Hipótese Diagnóstica e o CID previsto.", "A vaga para atendimento não é regulada, sendo disponibilizada via SIRESP.", "O serviço para adultos será iniciado após a redução da lista de espera pediátrica."],
                "fluxo": ["Profissional acede ao prontuário eletrónico (MV/SIGSS) e confirma o atendimento.", "Na aba 'Encaminhamento', seleciona a especialidade 'PSICOLOGIA CLÍNICA'.", "Insere o SOAP (Atenção Primária) ou Hipótese Diagnóstica e o CID correto.", "Após o encaminhamento, a vaga será disponibilizada para agendamento via SIRESP."],
                "cids": "F32, F33, F34, F39, F41, F43, F52, F53, F54, F59, F68, F69",
                "idades": "A partir de 18 anos",
               "anexos": [
                    { "nome": "Estratificação de risco.pdf", "url": "https://drive.google.com/file/d/1opiU4aQQK856BaoAFmTtglrncpU2nbPM/view?usp=drive_link" }
                ]
            },
            {
                "id": "6",
                "nome": "Encaminhamento para Psiquiatria Pediátrica",
                "tema": "Saúde Mental Infantil / Juvenil",
                "resumo": "Define que não há encaminhamento direto para Psiquiatria Pediátrica. Todas as demandas devem ser primeiramente avaliadas pela equipa de Psicologia Pediátrica da Policlínica.",
                "descricao": "Este é um protocolo de fluxo que estabelece a Psicologia Pediátrica como a porta de entrada para demandas de saúde mental de crianças e adolescentes que possam necessitar de avaliação psiquiátrica. A equipa especializada da Policlínica é responsável por avaliar o caso e, se necessário, realizar o encaminhamento interno para a Psiquiatria.",
                "principais": ["NÃO HÁ ENCAMINHAMENTO DIRETO para a Psiquiatria Pediátrica.", "Todas as demandas devem ser obrigatoriamente encaminhadas primeiro para 'PSICOLOGIA PEDIÁTRICA'.", "A equipa de Psicologia da Policlínica fará a avaliação e o encaminhamento interno, se necessário."],
                "fluxo": ["Identificar a demanda de saúde mental na criança ou adolescente.", "Seguir o protocolo de 'Encaminhamento para Psicologia Pediátrica'.", "Aguardar a avaliação da equipa especializada da Policlínica, que determinará a necessidade de acompanhamento psiquiátrico."],
                "cids": "Não aplicável (encaminhamento indireto)",
                "idades": "3 a 17 anos",
               "anexos": [
                    { "nome": "Estratificação de risco.pdf", "url": "https://drive.google.com/file/d/1opiU4aQQK856BaoAFmTtglrncpU2nbPM/view?usp=drive_link" }
                ]
            },
            {
                "id": "7",
                "nome": "Encaminhamento para Psiquiatria Adulto",
                "tema": "Saúde Mental Adulto",
                "resumo": "Define o fluxo para encaminhar pacientes a partir de 18 anos, com risco médio, para a especialidade de Psiquiatria. O processo é feito via MV/SIGSS e a vaga disponibilizada por SIRESP.",
                "descricao": "Este protocolo orienta o profissional da Atenção Primária ou Especializada a realizar o encaminhamento para Psiquiatria Adulto através do prontuário eletrónico. É mandatório o preenchimento do SOAP ou Hipótese Diagnóstica e a inserção do CID correto. A vaga não é regulada, sendo disponibilizada diretamente no sistema SIRESP para agendamento.",
                "principais": ["Para pacientes com 18 anos ou mais, classificados como risco médio.", "O encaminhamento é realizado pela aba 'Encaminhamento' no prontuário eletrónico (MV/SIGSS).", "É necessário inserir o SOAP ou Hipótese Diagnóstica e o CID.", "A vaga para atendimento é disponibilizada via SIRESP."],
                "fluxo": ["Profissional acede ao prontuário eletrónico (MV/SIGSS).", "Na aba 'Encaminhamento', seleciona a especialidade 'PSIQUIATRIA'.", "Insere o SOAP (Atenção Primária) ou Hipótese Diagnóstica e o CID correspondente.", "Após o encaminhamento, a vaga ficará disponível para agendamento no SIRESP."],
                "cids": "F32, F33, F34, F39, F41, F43, F52, F53, F54, F59, F68, F69",
                "idades": "A partir de 18 anos",
                "anexos": [
                    { "nome": "Estratificação de risco.pdf", "url": "https://drive.google.com/file/d/1opiU4aQQK856BaoAFmTtglrncpU2nbPM/view?usp=drive_link" }
                ]
            },
            {
                "id": "8",
                "nome": "Apoio ao Aleitamento Materno no Banco de Leite Humano (BLH)",
                "tema": "Saúde da Mulher / Saúde da Criança / Aleitamento Materno",
                "resumo": "Este protocolo detalha o fluxo de atendimento para nutrizes (mães lactantes) com dúvidas ou dificuldades no aleitamento materno, realizado pela equipa de enfermagem e nutricionistas do Banco de Leite Humano (BLH).",
                "descricao": "O atendimento visa oferecer suporte integral à mãe e ao bebé, abordando desde a técnica correta de amamentação até o manejo de complicações como fissuras, ingurgitamento ou mastite. O protocolo inclui a avaliação completa do binómio, orientações sobre ordenha, armazenamento do leite e encaminhamentos para outras especialidades, como odontologia neonatal, quando necessário.",
                "principais": ["O primeiro atendimento é realizado pela equipa de enfermagem, agendado presencialmente ou por WhatsApp.", "Avaliação completa das mamas da mãe (fissuras, ingurgitamento, mastite) e da sucção do bebé (pega, frénulo lingual).", "Em caso de mastite, é necessária uma avaliação médica (BLH, Maternidade Santa Isabel ou convénio).", "O BLH oferece orientações sobre ordenha manual, armazenamento de leite e manutenção da amamentação no retorno ao trabalho.", "Casos de dificuldade de sucção podem ser encaminhados para avaliação com a odontologia neonatal."],
                "fluxo": ["Nutriz com dúvidas entra em contacto com o Banco de Leite Humano (BLH) presencialmente ou por WhatsApp (14 99109-2307).", "A equipa de enfermagem realiza o primeiro atendimento e a triagem inicial.", "Realiza-se a avaliação da nutriz (anamnese, exame das mamas) e do lactente (padrão de sucção, ganho de peso).", "A equipa (enfermagem/nutricionista) fornece orientações e realiza as intervenções necessárias.", "Se identificada a necessidade, o caso é encaminhado para avaliação médica ou odontológica neonatal.", "Agenda-se o retorno para acompanhamento e reavaliação das condições da mãe e do bebé."],
                "cids": "Z39.1 (Cuidados e exames de mãe em lactação)",
                "idades": "Nutrizes (mães lactantes) e lactentes",
                "anexos": []
            },
            {
                "id": "9",
                "nome": "Captação e Triagem de Doadoras de Leite Humano (LHOC)",
                "tema": "Saúde da Mulher / Aleitamento Materno / Banco de Leite Humano",
                "resumo": "Define os critérios e o processo para mulheres em fase de lactação se tornarem doadoras de Leite Humano Ordenhado Cru (LHOC) para o Banco de Leite Humano (BLH) de Bauru, conforme a RDC nº 171/2006.",
                "descricao": "O protocolo estabelece que a doadora deve ser saudável, estar a amamentar com produção excedente e manifestar o desejo de doar voluntariamente. O processo inclui uma triagem rigorosa realizada pela enfermeira do BLH, com a necessidade de apresentar exames pré-natais recentes. O documento também detalha os métodos de captação de novas doadoras e os tipos de coleta (externa e interna).",
                "principais": ["A doadora deve estar saudável, amamentando e com produção de leite excedente.", "É necessário apresentar exames do pré-natal (Hemograma, Glicemia, Toxoplasmose, Sífilis, HIV, Hepatites B e C). Exames com mais de 6 meses serão refeitos.", "Critérios de exclusão: ser fumadora, usar álcool ou drogas ilícitas, usar medicamentos que interfiram na amamentação, ou ter feito tatuagem/piercing nos últimos 12 meses.", "A triagem é realizada pela enfermeira do BLH, que pode solicitar avaliação médica adicional.", "Após a aprovação, a doadora recebe um número de matrícula e entra na rota de coleta domiciliar ou pode entregar o leite diretamente no BLH."],
                "fluxo": ["A potencial doadora entra em contacto com o Banco de Leite Humano (BLH).", "A enfermeira do BLH realiza a triagem, informa sobre o cadastro e solicita os exames necessários.", "Os exames são avaliados. Se necessário, são realizadas novas coletas no domicílio ou no BLH.", "A doadora apta recebe um número de matrícula e é incluída na rota de coleta.", "Uma funcionária realiza a visita domiciliar para orientações e entrega dos materiais (frascos estéreis, máscaras, toucas).", "A coleta é realizada pela própria doadora e o leite é recolhido pela equipa do BLH (coleta externa) ou entregue pela doadora (coleta interna)."],
                "cids": "Z39.1 (Cuidados e exames de mãe em lactação)",
                "idades": "Mulheres em fase de lactação",
                "anexos": []
            },
            {
                "id": "10",
                "nome": "Programa de Bomba de Infusão de Insulina (BII)",
                "tema": "Endocrinologia Pediátrica / Diabetes Mellitus Tipo 1",
                "resumo": "Fornecimento de Bomba de Infusão de Insulina (BII) e insumos para pacientes diabéticos tipo 1, menores de 18 anos, em cumprimento à ação cível pública nº 401/2004.",
                "descricao": "Este protocolo detalha os critérios de inclusão, manutenção e exclusão de pacientes no programa de BII, que é gerido pela Unidade de Apoio Social. O fornecimento do equipamento e insumos é partilhado entre o Município de Bauru e o Estado (DRS VI).",
                "principais": ["Critério de Idade: Pacientes com até 17 anos, 11 meses e 29 dias.", "Critério Clínico: Diabetes Mellitus tipo 1 com falência do controlo glicémico pelos métodos convencionais, atestado por endocrinologista.", "A prescrição médica deve ser isenta de marca e modelo do equipamento.", "É necessário apresentar anualmente comprovativo de residência em Bauru e matrícula escolar.", "A manutenção no programa exige prescrição médica a cada 3 meses.", "Ao completar 18 anos, o paciente é automaticamente desligado do programa e deve devolver o equipamento."],
                "fluxo": ["Paciente apresenta a documentação necessária na Unidade de Apoio Social.", "O responsável assina o contrato de permissão de uso do aparelho.", "A Unidade de Apoio Social avalia a documentação e encaminha o paciente, de forma paritária, para o Município ou para o Estado (DRS VI).", "O ente responsável (Município ou Estado) fornece a BII e os insumos ao paciente.", "O paciente inicia o acompanhamento multidisciplinar obrigatório no Ambulatório de Especialidades Médica Municipal (CEMM) – Policlínica."],
                "cids": "E10 (Diabetes mellitus insulino-dependente)",
                "idades": "Menores de 18 anos",
                "anexos": [{ "nome": "Apêndice I - Contrato de Permissão de Uso.pdf", "url": "https://drive.google.com/file/d/1HMt-03ybHEFEsfLHbPIsvfjWOcXM3u5g/view?usp=sharing" }]
            }
            // Para adicionar um novo protocolo, copie e cole um dos blocos acima e altere os dados.
        ];

        // --- LÓGICA DA APLICAÇÃO ---
        let fuse;

        const ui = {
            mainScreen: document.getElementById('main-screen'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            noResults: document.getElementById('no-results'),
            protocolModal: document.getElementById('protocol-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalSummary: document.getElementById('modal-summary'),
            modalMainPoints: document.getElementById('modal-main-points'),
            modalFlow: document.getElementById('modal-flow'),
            modalAges: document.getElementById('modal-ages'),
            modalCids: document.getElementById('modal-cids'),
            modalAttachments: document.getElementById('modal-attachments'),
            closeProtocolModalBtn: document.getElementById('close-protocol-modal'),
        };

        const loadData = () => {
            const options = { keys: ['nome', 'tema', 'resumo', 'cids', 'descricao'], includeScore: true, threshold: 0.3, minMatchCharLength: 2, ignoreLocation: true };
            fuse = new Fuse(databaseDeProtocolos, options);
            displayResults(databaseDeProtocolos.map(p => ({ item: p })));
        };
        
        const performSearch = () => {
            const query = ui.searchInput.value.trim();
            const results = query ? fuse.search(query) : databaseDeProtocolos.map(p => ({ item: p }));
            displayResults(results);
        };

        const displayResults = (results) => {
            ui.searchResults.innerHTML = '';
            ui.noResults.classList.toggle('hidden', results.length > 0);
            results.forEach(result => {
                const protocol = result.item;
                const el = document.createElement('div');
                el.className = 'p-4 border rounded-lg hover:bg-gray-50 cursor-pointer';
                el.innerHTML = `<h3 class="font-semibold text-blue-700">${protocol.nome}</h3><p class="text-sm text-gray-600 mt-1">${(protocol.resumo || '').substring(0, 120)}...</p>`;
                el.addEventListener('click', () => showProtocolDetails(protocol));
                ui.searchResults.appendChild(el);
            });
        };
        
        const showProtocolDetails = (protocol) => {
            ui.modalTitle.textContent = protocol.nome || 'S/ Título';
            ui.modalSummary.textContent = protocol.resumo || 'N/A';
            ui.modalAges.textContent = protocol.idades || 'N/A';
            ui.modalCids.textContent = protocol.cids || 'N/A';
            
            ui.modalMainPoints.innerHTML = (Array.isArray(protocol.principais) && protocol.principais.length > 0) ? protocol.principais.map(p => `<li>${p}</li>`).join('') : '<li>N/A</li>';
            ui.modalFlow.innerHTML = (Array.isArray(protocol.fluxo) && protocol.fluxo.length > 0) ? protocol.fluxo.map(p => `<li>${p}</li>`).join('') : '<li>N/A</li>';
            
            ui.modalAttachments.innerHTML = '';
            if (Array.isArray(protocol.anexos) && protocol.anexos.length > 0) {
                 protocol.anexos.forEach(anexo => {
                    const link = document.createElement('a');
                    link.href = anexo.url;
                    link.target = '_blank';
                    link.className = 'flex items-center gap-2 text-blue-600 hover:underline bg-blue-50 p-2 rounded-md';
                    link.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>${anexo.nome}</span>`;
                    ui.modalAttachments.appendChild(link);
                });
            } else { ui.modalAttachments.innerHTML = '<p class="text-gray-500">Nenhum anexo disponível.</p>'; }

            openModal(ui.protocolModal);
        };

        const openModal = (modal) => modal.classList.add('is-open', 'modal-enter');
        const closeModal = (modal) => {
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.remove('is-open', 'modal-leave'), 300);
        };

        // --- EVENT LISTENERS ---
        ui.searchInput.addEventListener('input', performSearch);
        ui.closeProtocolModalBtn.addEventListener('click', () => closeModal(ui.protocolModal));
        
        // Carrega os dados assim que a página é aberta
        loadData();
    </script>
</body>
</html>

