<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocolo de Bolso - Saúde da Família</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.6.2/fuse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        /* (Seu CSS continua o mesmo, sem mudanças) */
        body { font-family: 'Inter', sans-serif; }
        .modal { display: none; } .modal.is-open { display: flex; }
        /* ... (resto do seu CSS) ... */
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-4xl mx-auto p-4 md:p-6">
        <div id="main-screen" class="bg-white p-6 md:p-8 rounded-xl shadow-lg w-full">
            </div>
    </div>
    <div id="protocol-modal" class="modal ...">
        </div>


    <script>
        // *** SUA CONFIGURAÇÃO DO FIREBASE ***
        const firebaseConfig = {
            apiKey: "AIzaSyBVoT23U4UfFqY9Q076q4g76K2NmcjS3jk",
            authDomain: "protocolos-b2a13.firebaseapp.com",
            projectId: "protocolos-b2a13",
            storageBucket: "protocolos-b2a13.firebasestorage.app",
            messagingSenderId: "999397114103",
            appId: "1:999397114103:web:fb94ab5e65184795f3d3f2",
            measurementId: "G-XEVSG8M6QZ"
        };
        
        // *** INICIALIZAR O FIREBASE ***
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); // Obter a referência do Firestore

        // const GOOGLE_SHEET_CSV_URL = '...'; // NÃO É MAIS USADO
        let fuse;

        // O objeto 'ui' é o mesmo
        const ui = {
            loadingState: document.getElementById('loading-state'),
            errorState: document.getElementById('error-state'),
            errorMessage: document.getElementById('error-message'),
            contentWrapper: document.getElementById('content-wrapper'),
            searchInput: document.getElementById('search-input'),
            searchResults: document.getElementById('search-results'),
            noResults: document.getElementById('no-results'),
            protocolModal: document.getElementById('protocol-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalSummary: document.getElementById('modal-summary'),
            modalMainPoints: document.getElementById('modal-main-points'),
            modalFlow: document.getElementById('modal-flow'),
            modalAges: document.getElementById('modal-ages'),
            modalCids: document.getElementById('modal-cids'),
            modalAttachments: document.getElementById('modal-attachments'),
            closeProtocolModalBtn: document.getElementById('close-protocol-modal'),
        };

        // A FUNÇÃO csvToJSON(csv) NÃO É MAIS NECESSÁRIA
        // Você pode removê-la

        /**
         * *** FUNÇÃO ATUALIZADA ***
         * Carrega os dados diretamente do Firestore
         */
        async function loadDataFromFirestore() {
            ui.loadingState.classList.remove('hidden');
            ui.errorState.classList.add('hidden');
            ui.contentWrapper.classList.add('hidden');
            
            try {
                // *** MUDANÇA PRINCIPAL: Buscar do Firestore ***
                // 'protocolos' é o nome da sua coleção. Mude se for diferente.
                const snapshot = await db.collection('protocolos').get();

                if (snapshot.empty) {
                    throw new Error('Nenhum protocolo encontrado no Firestore. Verifique a coleção "protocolos".');
                }

                // Mapeia os documentos para o formato que o app espera
                const databaseDeProtocolos = snapshot.docs.map(doc => {
                    return doc.data(); 
                    // Isso assume que seus documentos no Firestore têm campos
                    // como 'nome', 'resumo', 'cids', etc.
                });

                // O resto da lógica é o mesmo
                const options = { keys: ['nome', 'tema', 'resumo', 'cids', 'doencas'], threshold: 0.3 };
                fuse = new Fuse(databaseDeProtocolos, options);
                displayResults(databaseDeProtocolos.map(p => ({ item: p })));
                
                ui.loadingState.classList.add('hidden');
                ui.contentWrapper.classList.remove('hidden');

            } catch (error) {
                console.error("ERRO GRAVE ao carregar do Firestore:", error);
                ui.errorMessage.textContent = `Erro no Firestore: ${error.message}`;
                ui.loadingState.classList.add('hidden');
                ui.errorState.classList.remove('hidden');
            }
        }
        
        // As funções performSearch, displayResults, showProtocolDetails, openModal e closeModal
        // continuam EXATAMENTE IGUAIS. Não precisam de mudança.
        const performSearch = () => {
             if (!fuse) return;
            const query = ui.searchInput.value.trim();
            const results = query ? fuse.search(query) : fuse.getIndex().docs.map(p => ({ item: p }));
            displayResults(results);
        };
        
        const displayResults = (results) => {
            ui.searchResults.innerHTML = '';
            ui.noResults.classList.toggle('hidden', results.length === 0 && ui.searchInput.value.trim() !== '');
            results.forEach(result => {
                const protocol = result.item;
                const el = document.createElement('div');
                el.className = 'p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors';
                el.innerHTML = `<h3 class="font-semibold text-blue-700">${protocol.nome}</h3><p class="text-sm text-gray-600 mt-1">${(protocol.resumo || '').substring(0, 120)}...</p>`;
                el.addEventListener('click', () => showProtocolDetails(protocol));
                ui.searchResults.appendChild(el);
            });
        };
        
        const showProtocolDetails = (protocol) => {
            ui.modalTitle.textContent = protocol.nome || 'S/ Título';
            ui.modalSummary.textContent = protocol.resumo || 'N/A';
            ui.modalAges.textContent = protocol.idades || 'N/A';
            
            const cidsList = protocol.cids ? protocol.cids.split(';').map(c => c.trim()) : [];
            const doencasList = protocol.doencas ? protocol.doencas.split(';').map(d => d.trim()) : [];
            ui.modalCids.innerHTML = cidsList.map((cid, index) => `<b>${doencasList[index] || ''}</b> (${cid})`).join(', ') || 'N/A';
            
            const createList = (text) => text ? text.split(';').map(item => `<li>${item.trim()}</li>`).join('') : '<li>Nenhum item.</li>';
            ui.modalMainPoints.innerHTML = createList(protocol.principais);
            ui.modalFlow.innerHTML = createList(protocol.fluxo);
            
            ui.modalAttachments.innerHTML = '';
            if (protocol.anexos) {
                 protocol.anexos.split(';').forEach(anexoStr => {
                       const parts = anexoStr.split('|');
                       if(parts.length === 2 && parts[0].trim() && parts[1].trim()) {
                            const [nome, url] = parts;
                            const link = document.createElement('a');
                            link.href = url.trim();
                            link.target = '_blank';
                            link.className = 'flex items-center gap-2 text-blue-600 hover:underline bg-blue-50 p-2 rounded-md transition-colors';
                            link.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>${nome.trim()}</span>`;
                            ui.modalAttachments.appendChild(link);
                       }
                 });
             }
             if (!ui.modalAttachments.hasChildNodes()) {
                 ui.modalAttachments.innerHTML = '<p class="text-gray-500">Nenhum anexo disponível.</p>';
             }
            openModal(ui.protocolModal);
        };

        const openModal = (modal) => modal.classList.add('is-open', 'modal-enter');
        const closeModal = (modal) => {
            modal.classList.add('modal-leave');
            setTimeout(() => modal.classList.remove('is-open', 'modal-leave'), 300);
        };

        // Event Listeners (iguais)
        ui.searchInput.addEventListener('input', performSearch);
        ui.closeProtocolModalBtn.addEventListener('click', () => closeModal(ui.protocolModal));
        
        // *** PASSO 3: CHAMAR A NOVA FUNÇÃO ***
        loadDataFromFirestore(); // Em vez de loadDataFromDrive()

        // Lógica do Menu (igual)
        const menuButton = document.getElementById('menu-button');
        const menuDropdown = document.getElementById('menu-dropdown');
        menuButton.addEventListener('click', (event) => {
            event.stopPropagation();
            menuDropdown.classList.toggle('hidden');
        });
        window.addEventListener('click', (e) => {
            if (!menuButton.contains(e.target)) menuDropdown.classList.add('hidden');
        });

    </script>
</body>
</html>
